name: ci

on:
  push:
  pull_request:

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Verify CODEOWNERS
        run: scripts/ci/check_codeowners.sh
      - name: Verify branch name
        run: scripts/ci/check_branch_name.sh
      - name: Verify CHANGELOG update
        run: scripts/ci/check_changelog.sh
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libsqlite3-dev libssl-dev pkg-config curl python3 ffmpeg libavcodec-dev libavutil-dev libpq-dev
      - name: Smoke
        run: contrib/ci/smoke.sh
      - name: HLS memfd smoke
        run: tools/hls_memfd_smoke.sh
      - name: Telegram unit
        run: ./stream scripts/tests/telegram_unit.lua
      - name: Auth backend unit
        run: ./stream scripts/tests/auth_backend_unit.lua

  bundle-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libsqlite3-dev libssl-dev pkg-config curl python3 xz-utils libavcodec-dev libavutil-dev libpq-dev
      - name: Build bundle
        run: scripts/release/build_stream_bundle.sh --arch linux-x86_64 --profile lgpl
      - name: Smoke bundle
        run: contrib/ci/smoke_bundle_transcode.sh

  mpts-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libsqlite3-dev libssl-dev pkg-config curl python3 libavcodec-dev libavutil-dev libpq-dev
      - name: Smoke MPTS
        run: |
          contrib/ci/smoke_mpts.sh
          contrib/ci/smoke_mpts_dvbt.sh
          contrib/ci/smoke_mpts_dvbs.sh
          contrib/ci/smoke_mpts_multisection.sh
          contrib/ci/smoke_mpts_cat.sh
          contrib/ci/smoke_mpts_cat_multisection.sh
          contrib/ci/smoke_mpts_tot_disable.sh
          contrib/ci/smoke_mpts_eit_mask.sh

  transcode-workers-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libsqlite3-dev libssl-dev pkg-config curl python3 ffmpeg libavcodec-dev libavutil-dev libpq-dev
      - name: Smoke transcode per-output isolation
        run: contrib/ci/smoke_transcode_per_output_isolation.sh

  transcode-seamless-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libsqlite3-dev libssl-dev pkg-config curl python3 ffmpeg libavcodec-dev libavutil-dev libpq-dev
      - name: Smoke transcode seamless failover (udp proxy)
        run: contrib/ci/smoke_transcode_seamless_failover.sh
