name: ci

on:
  push:
  pull_request:

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Verify CODEOWNERS
        run: scripts/ci/check_codeowners.sh
      - name: Verify branch name
        run: scripts/ci/check_branch_name.sh
      - name: Verify CHANGELOG update
        run: scripts/ci/check_changelog.sh
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libsqlite3-dev libssl-dev pkg-config curl python3
      - name: Smoke
        run: contrib/ci/smoke.sh
      - name: Telegram unit
        run: ./astra scripts/tests/telegram_unit.lua

  bundle-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libsqlite3-dev libssl-dev pkg-config curl python3 xz-utils
      - name: Build bundle
        run: scripts/release/build_astral_bundle.sh --arch linux-x86_64 --profile lgpl
      - name: Smoke bundle
        run: contrib/ci/smoke_bundle_transcode.sh

  mpts-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libsqlite3-dev libssl-dev pkg-config curl python3
      - name: Smoke MPTS
        run: |
          contrib/ci/smoke_mpts.sh
          contrib/ci/smoke_mpts_dvbt.sh
          contrib/ci/smoke_mpts_dvbs.sh
          contrib/ci/smoke_mpts_multisection.sh
